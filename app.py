import os
from together import Together
import streamlit as st
import pandas as pd
import joblib
from datetime import datetime
from fpdf import FPDF

# -------------------------
# Page Config
# -------------------------
st.set_page_config(
    page_title="Heartly - AI Heart Health Assistant", 
    page_icon="‚ù§Ô∏è", 
    layout="wide",
    initial_sidebar_state="expanded"
)

# -------------------------
# Custom CSS for Professional UI
# -------------------------
st.markdown("""
<style>
    /* Main background and theme */
    .main {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 2rem;
    }
    
    /* Title styling */
    .main-title {
        text-align: center;
        color: white;
        font-size: 3.5rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .subtitle {
        text-align: center;
        color: #e0e7ff;
        font-size: 1.2rem;
        margin-bottom: 2rem;
    }
    
    /* Card styling */
    .stApp > div > div {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    
    /* Input field styling */
    .stTextInput > div > div > input,
    .stNumberInput > div > div > input,
    .stSelectbox > div > div > select {
        border-radius: 10px;
        border: 2px solid #e5e7eb;
        padding: 0.75rem;
        font-size: 1rem;
    }
    
    /* Button styling */
    .stButton > button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 12px;
        padding: 1rem 2rem;
        font-size: 1.1rem;
        font-weight: 600;
        width: 100%;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .stButton > button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    
    /* Section headers */
    h2, h3 {
        color: #1f2937;
        font-weight: 700;
    }
    
    /* Chat messages */
    .stChatMessage {
        border-radius: 15px;
        padding: 1rem;
        margin: 0.5rem 0;
    }
    
    /* Success/Error boxes */
    .stSuccess, .stError {
        border-radius: 12px;
        padding: 1.5rem;
        font-size: 1.1rem;
        font-weight: 600;
    }
    
    /* Sidebar styling */
    .css-1d391kg {
        background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
    }
    
    /* Info boxes */
    .info-box {
        background: #f0f9ff;
        border-left: 4px solid #3b82f6;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
    }
</style>
""", unsafe_allow_html=True)

# -------------------------
# Load Model & Preprocessing
# -------------------------
@st.cache_resource
def load_models():
    model = joblib.load("KNN_heart.pkl")
    scaler = joblib.load("scaler.pkl")
    expected_columns = joblib.load("columns.pkl")
    return model, scaler, expected_columns

model, scaler, expected_columns = load_models()

# -------------------------
# Setup Together Client
# -------------------------
TOGETHER_API_KEY = os.getenv("TOGETHER_API_KEY")
client = Together(api_key=TOGETHER_API_KEY)

# -------------------------
# PDF Report Generation
# -------------------------
class HeartlyReport(FPDF):
    def header(self):
        self.set_font('Arial', 'B', 20)
        self.set_text_color(102, 126, 234)
        self.cell(0, 10, 'Heartly', 0, 1, 'C')
        self.set_font('Arial', 'I', 12)
        self.set_text_color(100, 100, 100)
        self.cell(0, 10, 'AI-Powered Heart Health Assessment Report', 0, 1, 'C')
        self.ln(5)
        
    def footer(self):
        self.set_y(-15)
        self.set_font('Arial', 'I', 8)
        self.set_text_color(150, 150, 150)
        self.cell(0, 10, f'Generated by Heartly - Page {self.page_no()}', 0, 0, 'C')

def generate_pdf_report(user_data, prediction, tips, symptoms, chat_history):
    pdf = HeartlyReport()
    pdf.add_page()
    
    # Report header
    pdf.set_font('Arial', 'B', 16)
    pdf.set_text_color(0, 0, 0)
    pdf.cell(0, 10, 'Patient Information', 0, 1, 'L')
    pdf.ln(5)
    
    # Patient details
    pdf.set_font('Arial', '', 12)
    pdf.cell(0, 8, f"Name: {user_data['name']}", 0, 1)
    pdf.cell(0, 8, f"Date: {datetime.now().strftime('%B %d, %Y')}", 0, 1)
    pdf.cell(0, 8, f"Time: {datetime.now().strftime('%I:%M %p')}", 0, 1)
    pdf.ln(5)
    
    # Symptoms
    if symptoms:
        pdf.set_font('Arial', 'B', 14)
        pdf.cell(0, 10, 'Reported Symptoms:', 0, 1)
        pdf.set_font('Arial', '', 12)
        pdf.multi_cell(0, 8, symptoms)
        pdf.ln(5)
    
    # Health metrics
    pdf.set_font('Arial', 'B', 14)
    pdf.cell(0, 10, 'Health Metrics:', 0, 1)
    pdf.set_font('Arial', '', 12)
    pdf.cell(0, 8, f"Age: {user_data['Age']} years", 0, 1)
    pdf.cell(0, 8, f"Gender: {user_data['sex']}", 0, 1)
    pdf.cell(0, 8, f"Resting Blood Pressure: {user_data['RestingBP']} mm Hg", 0, 1)
    pdf.cell(0, 8, f"Cholesterol: {user_data['Cholesterol']} mg/dL", 0, 1)
    pdf.cell(0, 8, f"Max Heart Rate: {user_data['MaxHR']} bpm", 0, 1)
    pdf.cell(0, 8, f"Chest Pain Type: {user_data['chest_pain']}", 0, 1)
    pdf.ln(5)
    
    # Assessment result
    pdf.set_font('Arial', 'B', 14)
    pdf.set_text_color(220, 38, 38) if prediction == 1 else pdf.set_text_color(34, 197, 94)
    result_text = "HIGH RISK - Immediate medical attention recommended" if prediction == 1 else "LOW RISK - Continue healthy lifestyle"
    pdf.cell(0, 10, f'Assessment Result: {result_text}', 0, 1)
    pdf.set_text_color(0, 0, 0)
    pdf.ln(5)
    
    # AI Recommendations
    pdf.set_font('Arial', 'B', 14)
    pdf.cell(0, 10, 'Personalized Health Recommendations:', 0, 1)
    pdf.set_font('Arial', '', 11)
    pdf.multi_cell(0, 7, tips)
    pdf.ln(5)
    
    # Chat conversation
    if len(chat_history) > 1:
        pdf.add_page()
        pdf.set_font('Arial', 'B', 14)
        pdf.cell(0, 10, 'Consultation Conversation:', 0, 1)
        pdf.set_font('Arial', '', 10)
        
        for msg in chat_history:
            if msg['role'] == 'user':
                pdf.set_font('Arial', 'B', 10)
                pdf.multi_cell(0, 6, f"Patient: {msg['content']}")
                pdf.ln(2)
            elif msg['role'] == 'assistant':
                pdf.set_font('Arial', '', 10)
                pdf.multi_cell(0, 6, f"Heartly AI: {msg['content']}")
                pdf.ln(3)
    
    # Disclaimer
    pdf.add_page()
    pdf.set_font('Arial', 'B', 12)
    pdf.cell(0, 10, 'Medical Disclaimer:', 0, 1)
    pdf.set_font('Arial', '', 10)
    disclaimer = """This report is generated by Heartly, an AI-powered heart health assessment tool. 
This is NOT a substitute for professional medical advice, diagnosis, or treatment. 
Always seek the advice of your physician or other qualified health provider with any questions 
regarding a medical condition. Never disregard professional medical advice or delay seeking it 
because of information from this report.

Heartly uses machine learning algorithms to provide risk assessment based on the data provided. 
Results should be discussed with a healthcare professional for proper interpretation and action.

This report is for informational purposes only and should be presented to a licensed medical 
professional for validation and further evaluation."""
    pdf.multi_cell(0, 6, disclaimer)
    
    # Certification
    pdf.ln(10)
    pdf.set_font('Arial', 'I', 10)
    pdf.cell(0, 6, f'Report ID: HRTLY-{datetime.now().strftime("%Y%m%d%H%M%S")}', 0, 1)
    pdf.cell(0, 6, 'Verified AI Health Assessment Platform', 0, 1)
    
    return pdf.output(dest='S').encode('latin1')

# -------------------------
# Initialize Session State
# -------------------------
if "messages" not in st.session_state:
    st.session_state["messages"] = [
        {"role": "system", "content": "You are Heartly, a caring and professional heart health assistant. Provide evidence-based, supportive, and actionable health guidance."}
    ]

if "prediction_made" not in st.session_state:
    st.session_state["prediction_made"] = False

if "user_data" not in st.session_state:
    st.session_state["user_data"] = {}

# -------------------------
# Main UI
# -------------------------
st.markdown('<h1 class="main-title">‚ù§Ô∏è Heartly</h1>', unsafe_allow_html=True)
st.markdown('<p class="subtitle">Your AI-Powered Heart Health Companion</p>', unsafe_allow_html=True)

# Sidebar for branding and info
with st.sidebar:
    st.markdown("### About Heartly")
    st.info("""
    **Heartly** is an advanced AI-powered platform that helps assess your heart health risk 
    using machine learning algorithms and provides personalized health recommendations.
    
    ‚öïÔ∏è **Professional Grade**  
    ü§ñ **AI-Powered Analysis**  
    üìä **Evidence-Based**  
    üìÑ **Downloadable Reports**
    """)
    
    st.markdown("### How It Works")
    st.markdown("""
    1. **Enter** your health information
    2. **Describe** any symptoms you're experiencing
    3. **Get** instant AI risk assessment
    4. **Receive** personalized health tips
    5. **Chat** with our AI health coach
    6. **Download** your comprehensive report
    """)
    
    st.markdown("---")
    st.markdown("**‚ö†Ô∏è Medical Disclaimer:**  \nThis tool provides health information and risk assessment. It is NOT a substitute for professional medical advice.")

# Main content area
col1, col2 = st.columns([1, 1])

with col1:
    st.markdown("### üë§ Personal Information")
    user_name = st.text_input("Full Name *", placeholder="Enter your full name")
    age = st.slider("Age", 18, 100, 40)
    sex = st.selectbox("Gender", ["M", "F"], format_func=lambda x: "Male" if x == "M" else "Female")
    
    st.markdown("### ü©∫ Symptoms & Concerns")
    symptoms = st.text_area(
        "Describe any symptoms you're experiencing",
        placeholder="E.g., chest pain, shortness of breath, fatigue, dizziness...",
        height=100
    )

with col2:
    st.markdown("### üìä Vital Signs")
    resting_bp = st.number_input("Resting Blood Pressure (mm Hg)", 80, 200, 120)
    cholesterol = st.number_input("Cholesterol (mg/dL)", 100, 600, 200)
    max_hr = st.slider("Maximum Heart Rate", 60, 220, 150)
    oldpeak = st.slider("Oldpeak (ST Depression)", 0.0, 6.0, 1.0, 0.1)

st.markdown("---")

# Additional medical details in expandable sections
with st.expander("‚öïÔ∏è Additional Medical Details", expanded=False):
    col3, col4, col5 = st.columns(3)
    
    with col3:
        chest_pain = st.selectbox("Chest Pain Type", ["ATA", "NAP", "TA", "ASY"],
                                 help="ATA: Atypical Angina, NAP: Non-Anginal Pain, TA: Typical Angina, ASY: Asymptomatic")
        fasting_bs = st.selectbox("Fasting Blood Sugar > 120 mg/dL", [0, 1],
                                 format_func=lambda x: "No" if x == 0 else "Yes")
    
    with col4:
        resting_ecg = st.selectbox("Resting ECG", ["Normal", "ST", "LVH"],
                                  help="Normal, ST: ST-T wave abnormality, LVH: Left Ventricular Hypertrophy")
        exercise_angina = st.selectbox("Exercise-Induced Angina", ["N", "Y"],
                                      format_func=lambda x: "No" if x == "N" else "Yes")
    
    with col5:
        st_slope = st.selectbox("ST Slope", ["Up", "Flat", "Down"],
                               help="Slope of peak exercise ST segment")

st.markdown("---")

# -------------------------
# Predict Button
# -------------------------
col_btn1, col_btn2, col_btn3 = st.columns([1, 2, 1])

with col_btn2:
    predict_btn = st.button("üîç Analyze Heart Health", use_container_width=True)

if predict_btn:
    if not user_name:
        st.error("‚ö†Ô∏è Please enter your full name before proceeding.")
    else:
        with st.spinner("üîÑ Analyzing your heart health data..."):
            # Prepare input
            raw_input = {
                'Age': age,
                'RestingBP': resting_bp,
                'Cholesterol': cholesterol,
                'FastingBS': fasting_bs,
                'MaxHR': max_hr,
                'Oldpeak': oldpeak,
                'Gender_' + sex: 1,
                'ChestPainType_' + chest_pain: 1,
                'RestingECG_' + resting_ecg: 1,
                'ExerciseAngina_' + exercise_angina: 1,
                'ST_Slope_' + st_slope: 1
            }

            input_df = pd.DataFrame([raw_input])

            # Fill missing columns
            for col in expected_columns:
                if col not in input_df.columns:
                    input_df[col] = 0

            # Reorder columns
            input_df = input_df[expected_columns]

            # Scale input
            scaled_input = scaler.transform(input_df)

            # Predict
            prediction = model.predict(scaled_input)[0]
            
            # Store data for report
            st.session_state["user_data"] = {
                'name': user_name,
                'Age': age,
                'sex': 'Male' if sex == 'M' else 'Female',
                'RestingBP': resting_bp,
                'Cholesterol': cholesterol,
                'MaxHR': max_hr,
                'chest_pain': chest_pain,
                'symptoms': symptoms
            }
            st.session_state["prediction"] = prediction
            st.session_state["prediction_made"] = True

            # Display prediction with animation
            st.markdown("---")
            if prediction == 1:
                st.error("### ‚ö†Ô∏è HIGH RISK of Heart Disease Detected")
                st.warning("""
                **Immediate Action Recommended:**
                - Consult a cardiologist as soon as possible
                - Do not ignore this assessment
                - Download your report and bring it to your doctor
                """)
            else:
                st.success("### ‚úÖ LOW RISK of Heart Disease")
                st.info("""
                **Great News!** Your current health metrics indicate a lower risk. 
                Continue maintaining a healthy lifestyle and regular check-ups.
                """)

            # -------------------------
            # AI Health Tips
            # -------------------------
            st.markdown("---")
            st.markdown("### üí° Personalized Health Recommendations")
            
            with st.spinner("ü§ñ Generating personalized health tips..."):
                prompt = f"""
                Patient Information:
                - Name: {user_name}
                - Health Data: {raw_input}
                - Symptoms: {symptoms if symptoms else "None reported"}
                - Risk Assessment: {'HIGH RISK' if prediction == 1 else 'LOW RISK'}

                Provide 4-5 specific, actionable, and personalized health recommendations:
                1. Immediate actions (if high risk) or preventive measures (if low risk)
                2. Dietary modifications specific to their metrics
                3. Exercise recommendations appropriate for their age and condition
                4. Stress management and lifestyle tips
                5. Medical follow-up suggestions

                Be empathetic, encouraging, and professional. Focus on prevention and improvement.
                """

                try:
                    response = client.chat.completions.create(
                        model="meta-llama/Meta-Llama-3.1-8B-Instruct-Turbo",
                        messages=[
                            {"role": "system", "content": "You are Heartly, a professional heart health AI assistant providing evidence-based recommendations."},
                            {"role": "user", "content": prompt}
                        ],
                        temperature=0.7,
                        max_tokens=700
                    )
                    tips = response.choices[0].message.content.strip()
                    st.session_state["tips"] = tips

                    st.markdown(f"""
                    <div class="info-box">
                    {tips}
                    </div>
                    """, unsafe_allow_html=True)

                    # Add to chat history
                    st.session_state["messages"].append({"role": "assistant", "content": tips})

                except Exception as e:
                    st.error(f"Error generating recommendations: {e}")
                    st.session_state["tips"] = "Unable to generate recommendations at this time."

# -------------------------
# Chat Interface
# -------------------------
if st.session_state["prediction_made"]:
    st.markdown("---")
    st.markdown("## üí¨ Chat with Your AI Health Coach")
    st.markdown("*Ask any questions about your heart health, lifestyle, or the assessment results*")

    # Display past messages
    for msg in st.session_state["messages"]:
        if msg["role"] == "user":
            with st.chat_message("user", avatar="üë§"):
                st.markdown(msg["content"])
        elif msg["role"] == "assistant":
            with st.chat_message("assistant", avatar="‚ù§Ô∏è"):
                st.markdown(msg["content"])

    # User input
    if user_input := st.chat_input("Ask me anything about heart health..."):
        st.session_state["messages"].append({"role": "user", "content": user_input})
        
        with st.chat_message("user", avatar="üë§"):
            st.markdown(user_input)

        with st.chat_message("assistant", avatar="‚ù§Ô∏è"):
            with st.spinner("Thinking..."):
                try:
                    response = client.chat.completions.create(
                        model="meta-llama/Meta-Llama-3.1-8B-Instruct-Turbo",
                        messages=st.session_state["messages"],
                        temperature=0.7,
                        max_tokens=500
                    )
                    ai_reply = response.choices[0].message.content.strip()
                    st.session_state["messages"].append({"role": "assistant", "content": ai_reply})
                    st.markdown(ai_reply)
                except Exception as e:
                    st.error(f"‚ö†Ô∏è Chat error: {e}")

    # -------------------------
    # Download Report Button
    # -------------------------
    st.markdown("---")
    col_report1, col_report2, col_report3 = st.columns([1, 2, 1])
    
    with col_report2:
        if st.button("üìÑ Download Comprehensive Report (PDF)", use_container_width=True):
            with st.spinner("üìù Generating your comprehensive health report..."):
                try:
                    pdf_bytes = generate_pdf_report(
                        st.session_state["user_data"],
                        st.session_state["prediction"],
                        st.session_state.get("tips", ""),
                        symptoms,
                        st.session_state["messages"][1:]  # Exclude system message
                    )
                    
                    st.download_button(
                        label="‚¨áÔ∏è Click Here to Download Your Report",
                        data=pdf_bytes,
                        file_name=f"Heartly_Report_{user_name.replace(' ', '_')}_{datetime.now().strftime('%Y%m%d')}.pdf",
                        mime="application/pdf",
                        use_container_width=True
                    )
                    
                    st.success("‚úÖ Report generated successfully! Click the button above to download.")
                    
                except Exception as e:
                    st.error(f"Error generating report: {e}")
                    st.info("Please ensure you have completed the health assessment first.")

# Footer
st.markdown("---")
st.markdown("""
<div style='text-align: center; color: #6b7280; padding: 2rem;'>
    <p><strong>Heartly</strong> - AI-Powered Heart Health Assistant</p>
    <p style='font-size: 0.9rem;'>This tool is for informational purposes only and is not a substitute for professional medical advice.</p>
    <p style='font-size: 0.8rem; margin-top: 1rem;'>¬© 2024 Heartly. All rights reserved.</p>
</div>
""", unsafe_allow_html=True)
