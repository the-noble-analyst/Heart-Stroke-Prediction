from fpdf import FPDF
from datetime import datetime

class HeartAlertReport(FPDF):
    def header(self):
        self.set_font('Arial', 'B', 24)
        self.set_text_color(102, 126, 234)
        self.cell(0, 12, 'HeartAlert', 0, 1, 'C')
        self.set_font('Arial', 'I', 11)
        self.set_text_color(100, 100, 100)
        self.cell(0, 8, 'AI-Powered Heart Health Assessment Report', 0, 1, 'C')
        self.ln(8)

    def footer(self):
        self.set_y(-15)
        self.set_font('Arial', 'I', 8)
        self.set_text_color(150, 150, 150)
        self.cell(0, 10, f'Generated by HeartAlert - Page {self.page_no()}', 0, 0, 'C')

    def chapter_title(self, title):
        self.set_font('Arial', 'B', 14)
        self.set_fill_color(102, 126, 234)
        self.set_text_color(255, 255, 255)
        self.cell(0, 10, title, 0, 1, 'L', 1)
        self.ln(4)

    def chapter_body(self, body):
        self.set_font('Arial', '', 11)
        self.set_text_color(0, 0, 0)
        self.multi_cell(0, 7, body)
        self.ln()

def generate_pdf_report(user_data, prediction, tips, symptoms, chat_history):
    pdf = HeartAlertReport()
    pdf.add_page()

    patient_info = f"""Name: {user_data['name']}
Date: {datetime.now().strftime('%B %d, %Y')}
Time: {datetime.now().strftime('%I:%M %p')}
Report ID: HRT-{datetime.now().strftime('%Y%m%d%H%M%S')}"""

    pdf.chapter_title('PATIENT INFORMATION')
    pdf.chapter_body(patient_info)

    if symptoms:
        pdf.chapter_title('REPORTED SYMPTOMS')
        pdf.chapter_body(symptoms)

    pdf.chapter_title('HEALTH METRICS')
    pdf.chapter_body(f"""Age: {user_data['Age']} years
Gender: {user_data['sex']}
Resting Blood Pressure: {user_data['RestingBP']} mm Hg
Cholesterol: {user_data['Cholesterol']} mg/dL
Maximum Heart Rate: {user_data['MaxHR']} bpm
Chest Pain Type: {user_data['chest_pain']}
Oldpeak (ST Depression): {user_data['oldpeak']}
Fasting Blood Sugar: {'> 120 mg/dL' if user_data['fasting_bs'] else '< 120 mg/dL'}
Resting ECG: {user_data['resting_ecg']}
Exercise Angina: {user_data['exercise_angina']}
ST Slope: {user_data['st_slope']}""")

    pdf.chapter_title('RISK ASSESSMENT')
    pdf.set_font('Arial', 'B', 12)

    if prediction == 1:
        pdf.set_text_color(220, 38, 38)
        pdf.multi_cell(0, 8, "HIGH RISK - Immediate medical consultation recommended")
    else:
        pdf.set_text_color(34, 197, 94)
        pdf.multi_cell(0, 8, "LOW RISK - Continue maintaining healthy lifestyle")

    pdf.set_text_color(0, 0, 0)

    pdf.chapter_title('PERSONALIZED HEALTH RECOMMENDATIONS')
    pdf.chapter_body(tips)

    if chat_history:
        pdf.add_page()
        pdf.chapter_title('AI CONSULTATION CONVERSATION')
        for msg in chat_history:
            prefix = "Patient" if msg["role"] == "user" else "HeartAlert AI"
            pdf.multi_cell(0, 6, f"{prefix}: {msg['content']}")
            pdf.ln(2)

    pdf.add_page()
    pdf.chapter_title('MEDICAL DISCLAIMER')
    pdf.chapter_body("""This report is generated by HeartAlert, an AI-powered heart health assessment tool. This is NOT a substitute for professional medical advice, diagnosis, or treatment.

Always seek the advice of your physician or other qualified health provider with any questions regarding a medical condition.

This report is for informational purposes only.""")

    return pdf.output(dest='S').encode('latin1')
